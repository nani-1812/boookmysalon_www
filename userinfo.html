<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sign Up | Book My Salon</title>
    <link rel="stylesheet" href="global.css" />
    <style>
        /* Specific styles for the Sign Up form for better appearance */
        .info-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            flex-grow: 1; /* Allows section to take up available space */
            padding: 2rem;
            width: 100%;
            box-sizing: border-box; /* Include padding in element's total width and height */
        }

        .info-section form {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-medium);
            padding: 2.5rem 2rem; /* Increased padding for better spacing */
            max-width: 500px;
            width: 100%; /* Make form take full width up to max-width */
            margin: 0 auto; /* Center the form */
            box-sizing: border-box;
        }

        .info-section h2 {
            font-size: 2rem; /* Larger heading */
            margin-bottom: 1rem;
            color: var(--text-primary);
            text-align: center;
        }

        .info-section .subtitle {
            text-align: center;
            margin-bottom: 2rem; /* More space below subtitle */
            font-size: 1rem;
            color: var(--text-secondary);
        }

        .form-group {
            margin-bottom: 1.5rem; /* Space between form groups */
        }

        .form-group label {
            display: block; /* Label on its own line */
            margin-bottom: 0.6rem; /* Space between label and input */
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.95rem;
        }

        .phone-input-group {
            display: flex;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            overflow: hidden; /* Ensures borders are rounded correctly */
            background-color: var(--bg-color); /* Matches input background */
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        .phone-input-group:focus-within {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px var(--primary-color-light-alpha); /* Light glow */
        }

        .country-code {
            padding: 0.75rem 1rem;
            background-color: var(--bg-color); /* Background for country code */
            color: var(--text-secondary);
            border-right: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            font-weight: 500;
        }

        .phone-input-group input[type="tel"],
        .info-section input[type="text"],
        .info-section input[type="password"] { /* Added password type for consistency */
            flex-grow: 1; /* Take up remaining space */
            padding: 0.75rem 1rem;
            border: none;
            outline: none;
            font-size: 1rem;
            color: var(--text-primary);
            background-color: var(--bg-color); /* Match theme background */
            width: 100%; /* Ensure inputs fill container */
            box-sizing: border-box;
            -webkit-appearance: none; /* Remove default styling on iOS */
            -moz-appearance: none; /* Remove default styling on Firefox */
            appearance: none;
        }

        /* Specific styling for the full name input if it's not part of phone group */
        .info-section input[type="text"],
        .info-section input[type="password"] { /* Apply consistent styling */
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            background-color: var(--bg-color);
            padding: 0.75rem 1rem;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        .info-section input[type="text"]:focus,
        .info-section input[type="password"]:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px var(--primary-color-light-alpha);
        }

        .validation-message {
            min-height: 1.2em; /* Reserve space for validation messages */
            margin-top: 0.5rem;
            font-size: 0.85rem;
            color: red; /* Default to red for error messages */
        }

        .submit-btn {
            width: 100%;
            padding: 1rem;
            background-color: var(--primary-color);
            color: var(--button-text);
            border: none;
            border-radius: var(--border-radius);
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s ease, opacity 0.3s ease;
            margin-top: 2rem; /* Space above button */
        }

        .submit-btn:hover:not(:disabled) {
            background-color: var(--primary-color-dark);
        }

        .submit-btn:disabled {
            background-color: var(--border-color); /* Lighter background when disabled */
            color: var(--text-secondary);
            cursor: not-allowed;
            opacity: 0.7;
        }

        .login-link-container {
            text-align: center;
            display: block;
            margin-top: 2rem; /* More space below form */
            font-size: 1rem;
            color: var(--text-primary);
        }

        .login-link-container a {
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 600;
        }
        .login-link-container a:hover {
            text-decoration: underline;
        }

        /* Responsive adjustments */
        @media (max-width: 600px) {
            .info-section form {
                padding: 1.5rem 1rem;
            }
            .info-section h2 {
                font-size: 1.75rem;
            }
            .submit-btn {
                font-size: 1rem;
                padding: 0.9rem;
            }
        }
    </style>
</head>
<body data-theme="light">
    <header>
        <a href="frontpage.html" class="logo" id="logoLink">Book My Salon</a>
        <div class="header-controls">
            <div class="header-actions">
                <button class="theme-toggle" id="themeToggle" aria-label="Toggle theme">ðŸŒ™</button>
            </div>
        </div>
    </header>

    <section class="info-section">
        <form id="signupForm">
            <h2>Sign Up and Get Started</h2>
            <p class="subtitle">
                Enter your details to create an account
            </p>

            <div class="form-group">
                <label for="fullName">Full Name</label>
                <input
                    type="text"
                    id="fullName"
                    name="fullName"
                    placeholder="Enter your full name"
                    autocomplete="name"
                    required
                />
                <div class="validation-message" id="fullNameValidation"></div>
            </div>

            <div class="form-group">
                <label for="phoneNumber">Phone Number</label>
                <div class="phone-input-group">
                    <span class="country-code">+91</span>
                    <input
                        type="tel"
                        id="phoneNumber"
                        name="phoneNumber"
                        placeholder="Enter your 10-digit phone number"
                        maxlength="10"
                        pattern="[0-9]{10}"
                        autocomplete="tel"
                        required
                    />
                </div>
                <div class="validation-message" id="phoneValidation"></div>
            </div>

            <div id="otpVerificationSection" style="display:none;" class="form-group">
                <label for="otpInput">Enter OTP</label>
                <input type="text" id="otpInput" placeholder="Enter 6-digit OTP" required maxlength="6" pattern="[0-9]{6}"/>
                <div class="validation-message" id="otpError"></div>
            </div>

            <div class="validation-message" id="apiMessage"></div> 
            <button type="button" class="submit-btn" id="sendOtpBtn">
                Send OTP for Signup
            </button>
            <button type="submit" class="submit-btn" id="verifyAndRegisterBtn" style="display:none; margin-top: 1rem;">
                Verify OTP and Register
            </button>
        </form>

        <div class="login-link-container">
            Already have an account? <a href="login.html">Login</a>
        </div>
    </section>

    <footer>
        <p>Â© 2025 Book My Salon. All rights reserved.</p>
    </footer>

    <script src="theme-switcher.js"></script>

    <script>
        const API_BASE_URL = 'http://localhost:3000';

        // Element references
        const fullNameInput = document.getElementById('fullName');
        const phoneNumberInput = document.getElementById('phoneNumber');
        const sendOtpBtn = document.getElementById('sendOtpBtn');
        const verifyAndRegisterBtn = document.getElementById('verifyAndRegisterBtn');
        const otpVerificationSection = document.getElementById('otpVerificationSection');
        const otpInput = document.getElementById('otpInput');
        const phoneValidationDiv = document.getElementById('phoneValidation');
        const fullNameValidationDiv = document.getElementById('fullNameValidation');
        const otpErrorDiv = document.getElementById('otpError');
        const apiMessageDiv = document.getElementById('apiMessage');

        // Logo Link Management
        function updateLogoLink() {
            const token = localStorage.getItem('authToken') || localStorage.getItem('salonAuthToken');
            const logoLink = document.getElementById('logoLink');
            if (logoLink) {
                logoLink.href = localStorage.getItem('salonAuthToken') ? "salon-dashboard.html" : (localStorage.getItem('authToken') ? "dashboard.html" : "frontpage.html");
            }
        }

        // Display Message Helper
        function displayMessage(element, message, isError = true) {
            if (element) {
                element.textContent = message;
                element.style.color = isError ? 'red' : 'green';
            }
        }

        // --- Validation Functions ---
        function validateFullName(fullName) {
            if (!fullName || fullName.trim().length < 3) {
                displayMessage(fullNameValidationDiv, 'Full name is required and must be at least 3 characters.');
                return false;
            }
            displayMessage(fullNameValidationDiv, '', false); // Clear error
            return true;
        }

        function validatePhoneNumber(phoneNumber) {
            if (!phoneNumber || !/^\d{10}$/.test(phoneNumber)) {
                displayMessage(phoneValidationDiv, 'Please enter a valid 10-digit phone number.');
                return false;
            }
            displayMessage(phoneValidationDiv, '', false); // Clear error
            return true;
        }

        function validateOtp(otp) {
            if (!otp || !/^\d{6}$/.test(otp)) {
                displayMessage(otpErrorDiv, 'Please enter a valid 6-digit OTP.');
                return false;
            }
            displayMessage(otpErrorDiv, '', false); // Clear error
            return true;
        }
        // --- End Validation Functions ---


        // --- Event Listeners for Real-time Validation ---
        fullNameInput.addEventListener('input', (e) => validateFullName(e.target.value));
        phoneNumberInput.addEventListener('input', (e) => validatePhoneNumber(e.target.value));
        otpInput.addEventListener('input', (e) => validateOtp(e.target.value));
        // --- End Event Listeners for Real-time Validation ---


        // --- Send OTP Handler ---
        sendOtpBtn.addEventListener('click', async (e) => {
            e.preventDefault();

            const fullName = fullNameInput.value.trim();
            const phoneNumber = phoneNumberInput.value.trim();

            // Validate all fields before sending OTP
            const isFullNameValid = validateFullName(fullName);
            const isPhoneNumberValid = validatePhoneNumber(phoneNumber);

            if (!isFullNameValid || !isPhoneNumberValid) {
                displayMessage(apiMessageDiv, 'Please correct the errors in the form.', true);
                return;
            }

            sendOtpBtn.disabled = true;
            sendOtpBtn.textContent = 'Sending OTP...';
            displayMessage(apiMessageDiv, '', false); // Clear previous messages

            const fullPhoneNumber = `+91${phoneNumber}`;

            try {
                // Call the new Twilio Send OTP API endpoint for user-signup
                const response = await fetch(`${API_BASE_URL}/api/auth/send-otp`, { // <--- Changed Endpoint
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ phoneNumber: fullPhoneNumber, mode: 'user-signup' }) // <--- Added mode
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    displayMessage(apiMessageDiv, 'OTP sent successfully! Enter the code to register.', false);
                    localStorage.setItem('tempPhoneNumber', phoneNumber); // Store temporarily
                    localStorage.setItem('tempFullName', fullName);     // Store temporarily
                    localStorage.setItem('otpMode', 'user-signup');     // Identify the mode

                    // Show OTP section and hide send button
                    otpVerificationSection.style.display = 'block';
                    sendOtpBtn.style.display = 'none';
                    verifyAndRegisterBtn.style.display = 'block';

                } else if (data.action === 'redirect_to_login') { // Backend might send action
                    displayMessage(apiMessageDiv, data.message || 'This phone number is already registered. Redirecting to login...', true);
                    localStorage.removeItem('tempPhoneNumber');
                    localStorage.removeItem('tempFullName');
                    localStorage.removeItem('otpMode');
                    setTimeout(() => { window.location.href = 'login.html'; }, 2000);
                }
                else {
                    displayMessage(apiMessageDiv, data.message || 'Failed to send OTP. Please check your number.');
                }

            } catch (error) {
                console.error('Send OTP Error:', error);
                displayMessage(apiMessageDiv, 'Network error. Could not connect to the server.');
            } finally {
                if (otpVerificationSection.style.display !== 'block') { // Only re-enable if OTP not successfully sent
                    sendOtpBtn.disabled = false;
                    sendOtpBtn.textContent = 'Send OTP for Signup';
                }
            }
        });
        // --- End Send OTP Handler ---


        // --- Verify OTP and Register Handler ---
        verifyAndRegisterBtn.addEventListener('click', async (e) => {
            e.preventDefault();

            const phoneNumber = localStorage.getItem('tempPhoneNumber');
            const fullName = localStorage.getItem('tempFullName');
            const otp = otpInput.value.trim();
            const mode = localStorage.getItem('otpMode'); // Retrieve the mode for verification

            // Basic validation for OTP
            if (!validateOtp(otp)) {
                displayMessage(apiMessageDiv, 'Please enter a valid 6-digit OTP.', true);
                return;
            }
            if (!phoneNumber || !fullName || mode !== 'user-signup') { // Ensure mode is correct
                displayMessage(apiMessageDiv, 'Session expired or data missing. Please restart signup.', true);
                // Optionally redirect to refresh page
                // setTimeout(() => window.location.reload(), 2000);
                return;
            }

            verifyAndRegisterBtn.disabled = true;
            verifyAndRegisterBtn.textContent = 'Verifying & Registering...';
            displayMessage(apiMessageDiv, '', false); // Clear previous messages

            try {
                // First, verify the OTP using user auth endpoint
                const verifyResponse = await fetch(`${API_BASE_URL}/api/auth/verify-otp`, { // <--- Changed Endpoint
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ phoneNumber: `+91${phoneNumber}`, otp: otp, mode: mode }) // <--- Added mode
                });
                const verifyData = await verifyResponse.json();

                if (verifyResponse.ok && verifyData.success) {
                    // OTP is verified. Now proceed with user registration.
                    displayMessage(apiMessageDiv, 'OTP verified. Registering account...', false);

                    // If your /api/auth/verify-otp already registers the user upon successful OTP,
                    // you might not need a separate /api/auth/register call.
                    // Assuming verify-otp *does* handle registration for 'user-signup' mode:
                    if (verifyData.token) {
                        localStorage.removeItem('tempPhoneNumber'); // Clear temporary data
                        localStorage.removeItem('tempFullName');
                        localStorage.removeItem('otpMode');

                        // Store actual auth token and user name
                        localStorage.setItem('authToken', verifyData.token);
                        localStorage.setItem('userName', verifyData.user.fullName); // Use user details from verifyData

                        displayMessage(apiMessageDiv, 'Registration successful! Redirecting to dashboard...', false);
                        setTimeout(() => {
                            window.location.href = 'dashboard.html';
                        }, 1500);
                    } else {
                        // This else block might be hit if verify-otp succeeds but doesn't return a token
                        // which implies registration didn't complete or the response structure is different.
                        displayMessage(apiMessageDiv, 'OTP verified, but failed to complete registration. Please try again.', true);
                    }
                    
                    // Old approach: Separate register call (remove this if verify-otp handles registration)
                    /*
                    const registerResponse = await fetch(`${API_BASE_URL}/api/auth/register`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            fullName: fullName,
                            phoneNumber: `+91${phoneNumber}`
                        })
                    });
                    const registerData = await registerResponse.json();

                    if (registerResponse.ok && registerData.success) {
                        displayMessage(apiMessageDiv, 'Registration successful! Redirecting to dashboard...', false);
                        localStorage.removeItem('tempPhoneNumber'); // Clear temporary data
                        localStorage.removeItem('tempFullName');
                        localStorage.removeItem('otpMode');

                        // Store actual auth token and user name
                        localStorage.setItem('authToken', registerData.token);
                        localStorage.setItem('userName', registerData.user.fullName);

                        setTimeout(() => {
                            window.location.href = 'dashboard.html';
                        }, 1500);

                    } else if (registerResponse.status === 409) { // Phone number already registered
                        displayMessage(apiMessageDiv, 'This phone number is already registered. Redirecting to login...', true);
                        localStorage.removeItem('tempPhoneNumber');
                        localStorage.removeItem('tempFullName');
                        localStorage.removeItem('otpMode');
                        setTimeout(() => { window.location.href = 'login.html'; }, 2000);
                    } else {
                        displayMessage(apiMessageDiv, registerData.message || 'Registration failed. Please try again.');
                    }
                    */

                } else {
                    displayMessage(apiMessageDiv, verifyData.message || 'OTP verification failed. Please try again.');
                }

            } catch (error) {
                console.error('Registration/Verification Error:', error);
                displayMessage(apiMessageDiv, 'Network error during registration or verification.');
            } finally {
                verifyAndRegisterBtn.disabled = false;
                verifyAndRegisterBtn.textContent = 'Verify OTP and Register';
            }
        });
        // --- End Verify OTP and Register Handler ---


        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            updateLogoLink();
            // Check if there's ongoing OTP session from a previous reload/navigation
            const storedPhoneNumber = localStorage.getItem('tempPhoneNumber');
            const storedFullName = localStorage.getItem('tempFullName');
            const storedOtpMode = localStorage.getItem('otpMode');

            if (storedPhoneNumber && storedFullName && storedOtpMode === 'user-signup') {
                phoneNumberInput.value = storedPhoneNumber;
                fullNameInput.value = storedFullName;
                otpVerificationSection.style.display = 'block';
                sendOtpBtn.style.display = 'none';
                verifyAndRegisterBtn.style.display = 'block';
                displayMessage(apiMessageDiv, 'Please enter the OTP to complete registration.', false);
            }
        });
    </script>
</body>
</html>