<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>My Profile | Book My Salon</title>
    <link rel="stylesheet" href="global.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* --- Profile Page Specific Styles --- */
        
        /* Main Layout Adjustment */
        .main-content-area main { 
            flex: 1; 
            padding: 3rem 2rem;
            max-width: 800px; 
            margin: 0 auto; 
            width: 100%; 
        }

        /* Profile Card */
        .profile-container {
            background: var(--card-bg, #ffffff);
            padding: 2.5rem;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            text-align: center;
            color: var(--text-primary, #333);
        }

        .profile-container h1 {
            color: var(--primary-color, #ff6b6b);
            margin-bottom: 2rem;
            font-size: 2.5rem;
        }

        /* Info Rows */
        .profile-info-row {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 1.5rem;
            font-size: 1.1rem;
        }

        .profile-info-row label {
            font-weight: bold;
            margin-right: 1rem;
            min-width: 100px;
            text-align: right;
            color: var(--text-secondary, #555);
        }

        .profile-info-row span.display-value {
            text-align: left;
            font-weight: 500;
            flex-grow: 0;
            min-width: 200px;
        }

        /* Input Fields (Hidden by default) */
        .profile-info-row input {
            padding: 0.5rem;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 1rem;
            display: none; /* Hidden initially */
            width: 200px;
            background-color: var(--input-bg, #fff);
            color: var(--text-primary, #333);
        }

        /* Buttons */
        .profile-actions {
            margin-top: 2.5rem;
        }

        .btn {
            padding: 0.8rem 1.5rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            margin: 0 10px;
            transition: 0.3s;
        }

        .btn-primary {
            background-color: var(--primary-color, #ff6b6b);
            color: white;
        }
        
        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }
        
        .btn-success {
            background-color: #28a745;
            color: white;
        }

        /* Toggle classes for Edit Mode */
        .edit-mode .display-value { display: none; }
        .edit-mode input { display: block; }
        
        .edit-mode #editBtn { display: none; }
        .edit-mode #saveBtn, .edit-mode #cancelBtn { display: inline-block; }
        
        /* Default button visibility */
        #saveBtn, #cancelBtn { display: none; }

        /* Error/Login Message Styling */
        #authMessage {
            color: red;
            font-weight: bold;
            margin-bottom: 1rem;
            display: none;
            padding: 10px;
            background: #ffe6e6;
            border: 1px solid red;
            border-radius: 5px;
        }
    </style>
</head>
<body data-theme="light">
    <div class="dashboard-wrapper">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <a href="frontpage.html" class="logo">Book My Salon</a>
                <button class="toggle-btn" id="toggleBtn" title="Toggle Sidebar">‚ò∞</button>
            </div>
            <ul>
                <li data-page="dashboard.html"><a href="dashboard.html"><i class="fas fa-tachometer-alt"></i> <span>Dashboard</span></a></li>
                <li data-page="salons.html"><a href="salons.html"><i class="fas fa-store"></i> <span>Find Salons</span></a></li>
                <li data-page="appointments.html"><a href="appointments.html"><i class="fas fa-calendar-check"></i> <span>My Appointments</span></a></li>
                <li data-page="profile.html" class="active"><a href="profile.html"><i class="fas fa-user-circle"></i> <span>Profile</span></a></li>
                <li data-page="salon-register.html"><a href="salon-register.html"><i class="fas fa-building"></i> <span>Register Salon</span></a></li>
                <li data-action="logout"><a href="#" id="sidebarLogoutBtn"><i class="fas fa-sign-out-alt"></i> <span>Logout</span></a></li>
            </ul>
        </aside>

        <div class="main-content-area" id="mainContentArea">
            <header class="dashboard-header">
                <div class="header-right">
                    <button id="themeToggle" class="theme-toggle" title="Toggle Dark/Light Mode">üåô</button>
                    <button id="logoutBtn" class="btn btn-logout" style="margin-left: 1rem; padding: 5px 10px; border: 1px solid red; color: red; background: white; border-radius: 5px; cursor: pointer;">Logout</button>
                </div>
            </header>

            <main>
                <div class="profile-container" id="profileContainer">
                    <h1>My Profile</h1>
                    
                    <!-- Auth Error Message Area -->
                    <div id="authMessage"></div>

                    <!-- Profile Info Form -->
                    <div id="profileContent">
                        <div class="profile-info-row">
                            <label>Name:</label>
                            <span id="displayName" class="display-value">Loading...</span>
                            <input type="text" id="inputName" />
                        </div>
                        
                        <div class="profile-info-row">
                            <label>Phone:</label>
                            <span id="displayPhone" class="display-value">Loading...</span>
                            <input type="tel" id="inputPhone" readonly style="background-color: #eee; cursor: not-allowed;" title="Phone number cannot be changed" />
                        </div>
                        
                        <div class="profile-info-row">
                            <label>Email:</label>
                            <span id="displayEmail" class="display-value">Not Set</span>
                            <input type="email" id="inputEmail" />
                        </div>

                        <div class="profile-actions">
                            <button id="editBtn" class="btn btn-primary" onclick="toggleEditMode(true)">Edit Profile</button>
                            <button id="saveBtn" class="btn btn-success" onclick="saveProfile()">Save Changes</button>
                            <button id="cancelBtn" class="btn btn-secondary" onclick="toggleEditMode(false)">Cancel</button>
                        </div>
                    </div>
                </div>
            </main>

            <footer>
                <p>&copy; 2025 Book My Salon. All rights reserved.</p>
            </footer>
        </div>
    </div>

    <!-- Connect Theme Switcher -->
    <script src="theme-switcher.js"></script>

    <script>
        const API_BASE_URL = 'http://localhost:3000';

        // Robust token getter (checks multiple legacy keys for compatibility)
        function getAuthToken() {
            return localStorage.getItem('authToken')
                || localStorage.getItem('customerToken')
                || localStorage.getItem('salonAuthToken')
                || localStorage.getItem('salonToken')
                || localStorage.getItem('token')
                || null;
        }

        // --- 1. SAFE AUTH CHECK (NO REDIRECT LOOP) ---
        async function initProfile() {
            const token = getAuthToken();
            const profileContent = document.getElementById('profileContent');
            const authMessage = document.getElementById('authMessage');

            if (!token) {
                console.warn("Profile: No Auth Token found. Staying on page for debugging.");
                // Show message ON PAGE instead of redirecting
                authMessage.style.display = 'block';
                authMessage.innerHTML = 'You are not logged in. <a href="login.html">Click here to Login</a>';
                
                // DO NOT REDIRECT HERE
                // But still load any locally saved values (so user sees something)
                loadUserData(); 
                return; 
            } else {
                console.log("Profile: Token found. Attempting to load user data from server.");
                // If token exists, try to fetch fresh user data from API
                try {
                    const resp = await fetch(`${API_BASE_URL}/api/auth/user`, {
                        method: 'GET',
                        headers: {
                            'Authorization': 'Bearer ' + token,
                            'Content-Type': 'application/json'
                        }
                    });

                    if (resp.ok) {
                        const json = await resp.json();
                        if (json.success && json.user) {
                            // populate using server response
                            populateUserFromObject(json.user);
                            authMessage.style.display = 'none';
                            return;
                        } else {
                            console.warn('Profile: /api/auth/user returned no user. Falling back to localStorage.');
                            // fallthrough to local load
                        }
                    } else if (resp.status === 401 || resp.status === 403) {
                        console.warn('Profile: token invalid or expired (401/403). Clearing tokens and using local fallback.');
                        // clear stale tokens to let user re-login
                        localStorage.removeItem('authToken');
                        localStorage.removeItem('salonAuthToken');
                        localStorage.removeItem('customerToken');
                        authMessage.style.display = 'block';
                        authMessage.innerHTML = 'Session expired. <a href="login.html">Login again</a>';
                        loadUserData();
                        return;
                    } else {
                        console.warn('Profile: /api/auth/user returned non-ok status, falling back to localStorage.');
                    }
                } catch (err) {
                    console.error('Profile: Error fetching user from API:', err);
                    // Fall back to localStorage values if network/API fails
                }

                // If API failed or returned nothing, fall back to local storage
                loadUserData();
            }
        }

        // --- Populate UI from server/user object ---
        function populateUserFromObject(userObj) {
            const name = userObj.name || localStorage.getItem('userName') || 'Customer';
            const phone = userObj.phoneNumber || localStorage.getItem('tempPhoneNumber') || localStorage.getItem('userPhone') || 'N/A';
            const email = userObj.email || localStorage.getItem('userEmail') || '';

            document.getElementById('displayName').textContent = name;
            document.getElementById('displayPhone').textContent = phone;
            document.getElementById('displayEmail').textContent = email || 'Not provided';

            document.getElementById('inputName').value = name;
            document.getElementById('inputPhone').value = phone;
            document.getElementById('inputEmail').value = email;

            // Mirror to localStorage for offline use
            localStorage.setItem('userName', name);
            if (phone && phone !== 'N/A') localStorage.setItem('userPhone', phone);
            if (email) localStorage.setItem('userEmail', email);
        }

        // --- 2. LOAD DATA FROM LOCAL STORAGE (fallback) ---
        function loadUserData() {
            // Get data from localStorage
            const name = localStorage.getItem('userName') || 'Customer';
            const phone = localStorage.getItem('tempPhoneNumber') || localStorage.getItem('userPhone') || 'N/A';
            const email = localStorage.getItem('userEmail') || '';

            // Update Display Spans
            document.getElementById('displayName').textContent = name;
            document.getElementById('displayPhone').textContent = phone;
            document.getElementById('displayEmail').textContent = email || 'Not provided';

            // Update Input Fields for Editing
            document.getElementById('inputName').value = name;
            document.getElementById('inputPhone').value = phone;
            document.getElementById('inputEmail').value = email;
        }

        // --- 3. TOGGLE EDIT MODE ---
        function toggleEditMode(isEdit) {
            const container = document.getElementById('profileContainer');
            if (isEdit) {
                container.classList.add('edit-mode');
            } else {
                container.classList.remove('edit-mode');
                // Reset inputs to saved values on cancel
                loadUserData();
            }
        }

        // --- 4. SAVE PROFILE ---
        async function saveProfile() {
            const token = getAuthToken();
            if (!token) {
                alert("You appear to be logged out. Changes saved locally only.");
                // Fallback to local save if token missing to avoid blocking user
            }

            const newName = document.getElementById('inputName').value;
            const newEmail = document.getElementById('inputEmail').value;
            
            // Update LocalStorage directly to reflect changes immediately
            localStorage.setItem('userName', newName);
            localStorage.setItem('userEmail', newEmail);

            // If token exists, attempt to send to server (non-blocking)
            if (token) {
                try {
                    // Example endpoint; if your backend supports update profile, use it:
                    await fetch(`${API_BASE_URL}/api/auth/update-profile`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': 'Bearer ' + token
                        },
                        body: JSON.stringify({ name: newName, email: newEmail })
                    });
                    // ignore response for now; UI updated locally
                } catch (err) {
                    console.warn('Profile: failed to sync profile to server:', err);
                }
            }

            alert("Profile Updated Successfully!");
            toggleEditMode(false); // Exit edit mode
            loadUserData(); // Refresh display
        }

        // --- 5. LOGOUT LOGIC ---
        function logout() {
            localStorage.removeItem('authToken');
            localStorage.removeItem('salonAuthToken');
            localStorage.removeItem('customerToken');
            localStorage.removeItem('userName');
            localStorage.removeItem('userType');
            window.location.href = 'login.html'; // Manual redirect on click
        }

        // Event Listeners
        document.getElementById('logoutBtn').addEventListener('click', logout);
        document.getElementById('sidebarLogoutBtn').addEventListener('click', logout);

        // Initialize on Load
        document.addEventListener('DOMContentLoaded', () => {
            initProfile();

            // Sidebar Toggle Logic (Mobile)
            const toggleBtn = document.getElementById('toggleBtn');
            const sidebar = document.getElementById('sidebar');
            if(toggleBtn && sidebar) {
                toggleBtn.addEventListener('click', () => {
                    sidebar.classList.toggle('collapsed');
                });
            }
            
            // Theme Logic (Backup)
            const themeBtn = document.getElementById('themeToggle');
            if(themeBtn) {
                const savedTheme = localStorage.getItem('theme') || 'light';
                document.body.setAttribute('data-theme', savedTheme);
                themeBtn.textContent = savedTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
                themeBtn.addEventListener('click', () => {
                    const current = document.body.getAttribute('data-theme');
                    const next = current === 'dark' ? 'light' : 'dark';
                    document.body.setAttribute('data-theme', next);
                    localStorage.setItem('theme', next);
                    themeBtn.textContent = next === 'dark' ? '‚òÄÔ∏è' : 'üåô';
                });
            }
        });
    </script>
</body>
</html>
