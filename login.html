<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Login | Book My Salon</title>
    
    <!-- Connecting Global Styles for Background and Theme -->
    <link rel="stylesheet" href="global.css" />
    
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <style>
        /* --- Login Page Specific Styles --- */
        
        /* Main container alignment */
        main {
            display: flex;
            justify-content: center;
            align-items: center;
            flex-grow: 1;
            padding: 3rem 1rem;
            /* Uses the theme background color from global.css */
            background-color: var(--bg-color, #f4f7f6); 
            transition: background-color 0.3s ease;
        }

        .login-container {
            background: var(--card-bg, #ffffff);
            padding: 2.5rem 3rem;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            max-width: 450px;
            width: 100%;
            text-align: center;
            box-sizing: border-box;
            animation: fadeIn 0.5s ease-out;
            color: var(--text-primary, #333);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .login-container h2 {
            color: var(--primary-color, #ff6b6b);
            font-size: 2.2rem;
            margin-bottom: 0.8rem;
            font-weight: 600;
        }

        .login-container .subtitle {
            color: var(--text-secondary, #666);
            margin-bottom: 2.5rem;
            font-size: 1rem;
        }

        .form-group {
            margin-bottom: 1.8rem;
            text-align: left;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.6rem;
            font-weight: 600;
            color: var(--text-primary, #444);
            font-size: 0.95rem;
        }

        .phone-input-group {
            display: flex;
            align-items: center;
            border: 1px solid var(--border-color, #ddd);
            border-radius: 6px;
            background-color: var(--input-bg, #fff);
            overflow: hidden;
            transition: border-color 0.2s ease;
        }

        .phone-input-group:focus-within {
             border-color: var(--primary-color, #ff6b6b);
             box-shadow: 0 0 0 3px rgba(255, 107, 107, 0.2);
        }

        .phone-input-group .country-code {
            padding: 0.9rem 1.1rem;
            color: var(--text-secondary, #555);
            border-right: 1px solid var(--border-color, #ddd);
            background-color: var(--bg-secondary, #e9ecef);
            font-weight: 500;
        }

        .phone-input-group input[type="tel"] {
            flex-grow: 1;
            border: none;
            padding: 0.9rem 1.1rem;
            background-color: var(--input-bg, #fff);
            color: var(--text-primary, #333);
            font-size: 1rem;
            outline: none;
        }

        #otpVerificationSection input[type="text"] {
             padding: 0.9rem 1.1rem;
             border: 1px solid var(--border-color, #ddd);
             border-radius: 6px;
             background-color: var(--input-bg, #fff);
             color: var(--text-primary, #333);
             font-size: 1rem;
             outline: none;
             width: 100%;
             box-sizing: border-box;
             transition: border-color 0.2s ease;
        }
        #otpVerificationSection input[type="text"]:focus {
             border-color: var(--primary-color, #ff6b6b);
        }

        .validation-message, #apiMessage {
            min-height: 1.2em;
            margin-top: 0.6rem;
            font-size: 0.9em;
            color: red;
        }
        .validation-message.success {
             color: green !important;
        }

        .choice-buttons {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
            margin-bottom: 1.5rem;
        }

        .btn {
            padding: 0.9rem 1rem;
            font-size: 1rem;
            font-weight: 600;
            flex: 1;
            text-align: center;
            border: 1px solid transparent;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .btn-primary {
             background-color: var(--primary-color, #ff6b6b);
             color: white;
             border-color: var(--primary-color, #ff6b6b);
        }
        .btn-primary:hover {
            background-color: var(--primary-color-dark, #ff5252);
            border-color: var(--primary-color-dark, #ff5252);
        }
        .btn-primary:disabled {
            background-color: #ccc;
            border-color: #ccc;
            cursor: not-allowed;
        }

        .btn-secondary {
            background-color: transparent;
            color: var(--primary-color, #ff6b6b);
            border: 1px solid var(--primary-color, #ff6b6b);
        }
        .btn-secondary:hover {
             background-color: var(--primary-color, #ff6b6b);
             color: white;
        }
        .btn-secondary:disabled {
            border-color: #ccc;
            color: #ccc;
            cursor: not-allowed;
        }

        #verifyBtn {
             width: 100%;
             margin-top: 1rem;
        }

        .links {
            margin-top: 1.5rem;
            font-size: 0.95rem;
            color: var(--text-secondary, #666);
        }
        .links a {
            color: var(--primary-color, #ff6b6b);
            text-decoration: none;
            font-weight: 600;
        }
        .links a:hover {
            text-decoration: underline;
        }
        
        @media (max-width: 600px) {
            .login-container { padding: 2rem 1.5rem; }
            .choice-buttons { flex-direction: column; gap: 0.8rem; }
        }
    </style>
</head>
<body data-theme="light">
    <header>
        <a href="frontpage.html" class="logo">Book My Salon</a>
        <div class="header-controls">
            <div class="header-actions">
                <!-- Theme Toggle Button -->
                <button id="themeToggle" class="theme-toggle" title="Toggle Dark/Light Mode">ðŸŒ™</button>
            </div>
        </div>
    </header>

    <main>
        <div class="login-container">
            <h2>Welcome Back!</h2>
            <p class="subtitle">Login to access your bookings or manage your salon.</p>

            <form id="loginForm">
                <div class="form-group">
                    <label for="phone">Phone Number</label>
                    <div class="phone-input-group">
                        <span class="country-code">+91</span>
                        <input type="tel" id="phone" name="phone" placeholder="Enter 10-digit phone number" maxlength="10" pattern="[0-9]{10}" required />
                    </div>
                    <div class="validation-message" id="phoneError"></div>
                </div>

                <div id="otpVerificationSection" style="display:none;" class="form-group">
                    <label for="otpInput">Enter OTP</label>
                    <input type="text" id="otpInput" placeholder="Enter 6-digit OTP" maxlength="6" />
                    <div class="validation-message" id="otpError"></div>
                </div>

                <div id="apiMessage" class="validation-message"></div>

                <div class="choice-buttons">
                    <button type="button" class="btn btn-primary" id="sendOtpCustomerBtn" onclick="initiateLogin('user-login')">Login as Customer</button>
                    <button type="button" class="btn btn-secondary" id="sendOtpPartnerBtn" onclick="initiateLogin('salon-login')">Login as Partner</button>
                </div>

                <button type="submit" class="btn btn-primary" id="verifyBtn" style="display:none;">Verify and Login</button>
            </form>

            <div class="links">
                <p>Don't have an account? <a href="userinfo.html">Sign Up as Customer</a></p>
                <p>New Salon Partner? <a href="salon-register.html">Register here</a></p>
            </div>
        </div>
    </main>

    <footer>
        <p>&copy; 2025 Book My Salon. All rights reserved.</p>
    </footer>

    <!-- Connecting Theme Switcher Script -->
    <script src="theme-switcher.js"></script>
    
    <script>
        const API_BASE_URL = 'http://localhost:3000';
        const phoneInput = document.getElementById('phone');
        const verifyBtn = document.getElementById('verifyBtn');
        const otpSection = document.getElementById('otpVerificationSection');
        const otpInput = document.getElementById('otpInput');
        const sendCustomerBtn = document.getElementById('sendOtpCustomerBtn');
        const sendPartnerBtn = document.getElementById('sendOtpPartnerBtn');
        
        let currentOtpMode = '';

        // --- THEME TOGGLE LOGIC (Inline backup if theme-switcher.js fails) ---
        const themeToggle = document.getElementById('themeToggle');
        if(themeToggle) {
            // Check saved theme
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.body.setAttribute('data-theme', savedTheme);
            themeToggle.textContent = savedTheme === 'dark' ? 'â˜€ï¸' : 'ðŸŒ™';

            themeToggle.addEventListener('click', () => {
                const current = document.body.getAttribute('data-theme');
                const next = current === 'dark' ? 'light' : 'dark';
                document.body.setAttribute('data-theme', next);
                localStorage.setItem('theme', next);
                themeToggle.textContent = next === 'dark' ? 'â˜€ï¸' : 'ðŸŒ™';
            });
        }

        // --- UI UPDATES ---
        function showMessage(msg, isError = true) {
            const div = document.getElementById('apiMessage');
            div.textContent = msg;
            // Toggle 'success' class based on error state
            if (isError) {
                div.classList.remove('success');
                div.style.color = 'red';
            } else {
                div.classList.add('success');
                div.style.color = 'green';
            }
        }

        function toggleLoading(isLoading) {
            // Disable buttons while loading
            sendCustomerBtn.disabled = isLoading;
            sendPartnerBtn.disabled = isLoading;
            
            if (isLoading) {
                // Optional: Change text to indicate loading
                if (currentOtpMode === 'user-login') sendCustomerBtn.textContent = 'Sending...';
                else if (currentOtpMode === 'salon-login') sendPartnerBtn.textContent = 'Sending...';
            } else {
                // Reset text
                sendCustomerBtn.textContent = 'Login as Customer';
                sendPartnerBtn.textContent = 'Login as Partner';
            }
        }

        // --- STEP 1: SEND OTP ---
        async function initiateLogin(mode) {
            const phone = phoneInput.value.trim();
            if (phone.length !== 10 || isNaN(phone)) {
                showMessage('Please enter a valid 10-digit number.');
                return;
            }

            currentOtpMode = mode;
            showMessage('Sending OTP...', false);
            toggleLoading(true);

            try {
                let endpoint = mode === 'user-login' 
                    ? `${API_BASE_URL}/api/auth/send-otp` 
                    : `${API_BASE_URL}/api/salon/auth/send-otp`;

                const res = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ phoneNumber: '+91' + phone, mode: mode })
                });
                const data = await res.json();

                if (data.success) {
                    showMessage('OTP Sent Successfully!', false);
                    // Hide Send Buttons
                    document.querySelector('.choice-buttons').style.display = 'none';
                    // Show OTP Section
                    otpSection.style.display = 'block';
                    verifyBtn.style.display = 'block';
                    
                    // Store temp data
                    localStorage.setItem('tempPhoneNumber', phone);
                    localStorage.setItem('otpMode', mode);
                } else {
                    if(data.action === 'redirect_to_register') {
                        showMessage(data.message);
                        setTimeout(() => {
                             window.location.href = mode === 'user-login' ? 'userinfo.html' : 'salon-register.html';
                        }, 2000);
                    } else {
                        showMessage(data.message || 'Failed to send OTP.');
                    }
                }
            } catch (err) {
                console.error(err);
                showMessage('Network Error. Check console.');
            } finally {
                toggleLoading(false);
            }
        }

        // --- STEP 2: VERIFY OTP (Form Submit) ---
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            // If OTP section is not visible, do nothing (prevent accidental submit)
            if (otpSection.style.display === 'none') return;

            const otp = otpInput.value.trim();
            const phone = localStorage.getItem('tempPhoneNumber');
            
            if (otp.length !== 6) {
                showMessage('Enter a valid 6-digit OTP.');
                return;
            }

            verifyBtn.textContent = 'Verifying...';
            verifyBtn.disabled = true;

            try {
                let endpoint = currentOtpMode === 'user-login' 
                    ? `${API_BASE_URL}/api/auth/verify-otp` 
                    : `${API_BASE_URL}/api/salon/auth/verify-otp`;

                const res = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ phoneNumber: '+91' + phone, otp: otp, mode: currentOtpMode })
                });
                const data = await res.json();

                if (data.success) {
                    showMessage('Login Successful! Redirecting...', false);

                    // Ensure token present
                    if (data.token) {
                        // Canonical key used by new code
                        localStorage.setItem('authToken', data.token);

                        // Backwards compatibility / other pages may expect these keys:
                        localStorage.setItem('token', data.token);
                        // if customer:
                        if (currentOtpMode === 'user-login') {
                            localStorage.setItem('customerToken', data.token);
                            // also keep a short-named key some pages may use
                            localStorage.setItem('userType', 'customer');
                            if (data.user && data.user._id) {
                                localStorage.setItem('userId', data.user._id);
                                localStorage.setItem('userName', data.user.name || '');
                            }
                            // remove salon-specific tokens if any
                            localStorage.removeItem('salonAuthToken');
                            localStorage.removeItem('salonToken');

                            // Redirect AFTER saving
                            window.location.href = 'dashboard.html';
                        } else {
                            // partner
                            localStorage.setItem('salonAuthToken', data.token);
                            localStorage.setItem('salonToken', data.token);
                            localStorage.setItem('userType', 'salon');
                            if (data.salon && data.salon._id) {
                                localStorage.setItem('salonId', data.salon._id);
                                localStorage.setItem('salonName', data.salon.salonName || '');
                            }
                            // remove customer-specific token keys
                            localStorage.removeItem('customerToken');

                            window.location.href = 'salon-dashboard.html';
                        }
                    } else {
                        showMessage('Login succeeded but no token received from server.');
                    }
                } else {
                    showMessage(data.message || 'Verification Failed.');
                    verifyBtn.textContent = 'Verify and Login';
                    verifyBtn.disabled = false;
                }
            } catch (err) {
                console.error(err);
                showMessage('Verification Error.');
                verifyBtn.textContent = 'Verify and Login';
                verifyBtn.disabled = false;
            }
        });
    </script>
</body>
</html>
